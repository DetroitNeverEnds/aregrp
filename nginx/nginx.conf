# Подключение конфигураций upstream
include /etc/nginx/conf.d/upstream.conf;

# Подключение конфигурации кеша
include /etc/nginx/conf.d/cache.conf;

# Подключение конфигурации rate limiting
include /etc/nginx/conf.d/rate-limit.conf;

# Подключение конфигурации gzip
include /etc/nginx/conf.d/gzip.conf;

# Map для обработки OPTIONS запросов
map $request_method $options_method {
    default 0;
    OPTIONS 1;
}

# JSON формат логирования
log_format json_combined escape=json
'{'
'"time_local":"$time_local",'
'"remote_addr":"$remote_addr",'
'"remote_user":"$remote_user",'
'"request":"$request",'
'"status": "$status",'
'"body_bytes_sent":"$body_bytes_sent",'
'"request_time":"$request_time",'
'"http_referrer":"$http_referer",'
'"http_user_agent":"$http_user_agent",'
'"http_x_forwarded_for":"$http_x_forwarded_for",'
'"request_id":"$request_id",'
'"upstream_addr":"$upstream_addr",'
'"upstream_status":"$upstream_status",'
'"upstream_response_time":"$upstream_response_time",'
'"upstream_connect_time":"$upstream_connect_time"'
'}';

server {
    listen 80;
    server_name localhost;

    # Логирование в JSON формате
    access_log /var/log/nginx/access.log json_combined;
    error_log /var/log/nginx/error.log warn;

    # Увеличиваем размер буфера для больших запросов
    client_max_body_size 10M;
    client_body_buffer_size 128k;

    # Оптимизация буферов
    proxy_buffer_size 4k;
    proxy_buffers 8 4k;
    proxy_busy_buffers_size 8k;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }

    # Подключение роутинга для backend (API)
    include /etc/nginx/includes/backend-location.conf;

    # Подключение роутинга для frontend
    include /etc/nginx/includes/frontend-location.conf;
}