name: Deploy Testing

on:
    workflow_call:
        secrets:
            VPS_HOST:
                required: true
            VPS_USER:
                required: true
            VPS_SSH_KEY:
                required: true
            GITHUB_TOKEN:
                required: true
    pull_request:
        branches: [main]
        paths:
            - "**/*"
    workflow_dispatch:

env:
    # Имя образа: ghcr.io/ваш-юзер/ваш-репо
    REGISTRY: ghcr.io
    REGISTRY_PREFIX: ghcr.io/detroitneverends/aregrp/
    # TAG формируется в зависимости от типа запуска:
    # - Pull Request: pr-{номер}-{номер запуска}
    # - workflow_dispatch: {короткий хеш коммита} (первые 7 символов)
    # - Push: {имя ветки}-{номер запуска}
    TAG: ${{ github.event.pull_request.number && format('pr-{0}-{1}', github.event.pull_request.number, github.run_number) || (github.event_name == 'workflow_dispatch' && github.sha) || format('{0}-{1}', github.ref_name, github.run_number) }}

jobs:
    build-and-push:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
            - name: Log in to the Container registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            - name: Build and Push
              env:
                  REGISTRY_PREFIX: ${{ env.REGISTRY_PREFIX }}
                  TAG: ${{ env.TAG }}
              run: docker compose build && docker compose push
    deploy:
        needs: build-and-push
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # Копируем docker-compose.yml на сервер
            - name: Copy docker-compose via SCP
              uses: appleboy/scp-action@master
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  source: "docker-compose.yml"
                  target: "/home/${{ secrets.VPS_USER }}/aregrp/"

            # Подключаемся по SSH и обновляем контейнеры
            - name: Execute remote ssh commands
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      cd ~/aregrp/

                      # Логинимся в реестр GitHub на самом VPS, чтобы скачать приватный образ
                      echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

                      # Экспортируем переменные окружения для docker-compose
                      export REGISTRY_PREFIX=${{ env.REGISTRY_PREFIX }}
                      export TAG=${{ env.TAG }}

                      # Останавливаем, скачиваем и запускаем
                      docker compose pull
                      docker compose up -d --remove-orphans

                      # Чистим старые неиспользуемые образы, чтобы не забить диск
                      docker image prune -f
