name: Deploy Testing

on:
    workflow_call:
        secrets:
            VPS_HOST:
                required: true
            VPS_USER:
                required: true
            VPS_SSH_KEY:
                required: true
            ENV_FILE:
                required: false
            ENV_POSTGRES_FILE:
                required: false
    pull_request:
        branches: [main]
        paths:
            - "**/*"
    workflow_dispatch:

env:
    # Имя образа: ghcr.io/ваш-юзер/ваш-репо
    REGISTRY: ghcr.io
    REGISTRY_PREFIX: ghcr.io/detroitneverends/aregrp/
    # TAG формируется в зависимости от типа запуска:
    # - Pull Request: pr-{номер}-{номер запуска}
    # - workflow_dispatch: {короткий хеш коммита} (первые 7 символов)
    # - Push: {имя ветки}-{номер запуска}
    TAG: ${{ github.event.pull_request.number && format('pr-{0}-{1}', github.event.pull_request.number, github.run_number) || (github.event_name == 'workflow_dispatch' && github.sha) || format('{0}-{1}', github.ref_name, github.run_number) }}

jobs:
    build-and-push:
        name: Build and Push
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
            - name: Log in to the Container registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}
            
            # Примечание: .env файлы НЕ создаются здесь - они создаются на сервере из GitHub Secrets
            # Это гарантирует, что секреты не попадут в Docker образ (даже если .dockerignore пропустит)
            # 
            # Важно: env_file в docker-compose.yml используется ТОЛЬКО при запуске контейнеров (docker compose up),
            # НЕ при сборке (docker compose build). Поэтому сборка пройдет успешно без .env файлов.
            # Переменные ${REGISTRY_PREFIX} и ${TAG} задаются через env: блок ниже.
            - name: Build and Push
              env:
                  REGISTRY_PREFIX: ${{ env.REGISTRY_PREFIX }}
                  TAG: ${{ env.TAG }}
              run: docker compose build && docker compose push
    deploy:
        name: Deploy
        needs: build-and-push
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            # Копируем docker-compose.yml на сервер
            - name: Copy docker-compose via SCP
              uses: appleboy/scp-action@master
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  source: "docker-compose.yml"
                  target: "/home/${{ secrets.VPS_USER }}/aregrp/"

            # Создаем .env файлы на сервере из GitHub Secrets (безопасно, не попадают в Docker образ)
            - name: Create environment files from secrets
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      cd ~/aregrp/
                      mkdir -p backend
                      
                      # Создаем backend/.env из секрета (если секрет не задан, файл будет пустым)
                      if [ -n "${{ secrets.ENV_FILE }}" ]; then
                          echo "${{ secrets.ENV_FILE }}" > backend/.env
                          echo "✅ Created backend/.env from GitHub Secrets"
                      else
                          echo "⚠️  Warning: ENV_FILE secret is empty or not set"
                          echo "Creating empty backend/.env file. Please configure ENV_FILE secret."
                          touch backend/.env
                      fi
                      
                      # Создаем backend/.env.postgres из секрета (если секрет не задан, файл будет пустым)
                      if [ -n "${{ secrets.ENV_POSTGRES_FILE }}" ]; then
                          echo "${{ secrets.ENV_POSTGRES_FILE }}" > backend/.env.postgres
                          echo "✅ Created backend/.env.postgres from GitHub Secrets"
                      else
                          echo "⚠️  Warning: ENV_POSTGRES_FILE secret is empty or not set"
                          echo "Creating empty backend/.env.postgres file. Please configure ENV_POSTGRES_FILE secret."
                          touch backend/.env.postgres
                      fi

            # Подключаемся по SSH и обновляем контейнеры
            - name: Execute remote ssh commands
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.VPS_HOST }}
                  username: ${{ secrets.VPS_USER }}
                  key: ${{ secrets.VPS_SSH_KEY }}
                  script: |
                      cd ~/aregrp/

                      # Логинимся в реестр GitHub на самом VPS, чтобы скачать приватный образ
                      echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

                      # Экспортируем переменные окружения для docker-compose
                      export REGISTRY_PREFIX=${{ env.REGISTRY_PREFIX }}
                      export TAG=${{ env.TAG }}

                      # Останавливаем, скачиваем и запускаем
                      docker compose pull
                      docker compose up -d --remove-orphans

                      # Чистим старые неиспользуемые образы, чтобы не забить диск
                      docker image prune -f
