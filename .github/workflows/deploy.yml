name: Deploy to VPS

on:
  push:
    branches: [main]
    paths:
      - "frontend/**"
      - "backend/**"
      - "nginx/**"
      - "docker-compose.yml"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to deploy (e.g., v1.0.0)'
        required: false
        type: string

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    environment:
      name: production

    steps:
      - name: Determine deployment source
        id: deploy_source
        run: |
          if [ "${{ github.event_name }}" == "release" ]; then
            echo "source=release" >> $GITHUB_OUTPUT
            echo "tag=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Deploying from release: ${{ github.event.release.tag_name }}"
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ github.event.inputs.release_tag }}" ]; then
            echo "source=manual_release" >> $GITHUB_OUTPUT
            echo "tag=${{ github.event.inputs.release_tag }}" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Deploying from manual release: ${{ github.event.inputs.release_tag }}"
          else
            echo "source=branch" >> $GITHUB_OUTPUT
            echo "tag=" >> $GITHUB_OUTPUT
            echo "ðŸ”„ Deploying from branch: ${{ github.ref_name }}"
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.deploy_source.outputs.tag || github.ref }}

      - name: Download release assets (if deploying from release)
        if: steps.deploy_source.outputs.source == 'release' || steps.deploy_source.outputs.source == 'manual_release'
        run: |
          TAG="${{ steps.deploy_source.outputs.tag }}"
          echo "ðŸ“¥ Downloading release assets for $TAG"
          
          # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ Ð¿Ð°ÐºÐµÑ‚ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
          curl -L -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -o deployment.tar.gz \
            "https://github.com/${{ github.repository }}/releases/download/$TAG/aregrp-deploy-$TAG.tar.gz"
          
          echo "âœ… Downloaded deployment package"
          ls -lh deployment.tar.gz

      - name: Create deployment package (if deploying from branch)
        if: steps.deploy_source.outputs.source == 'branch'
        run: |
          echo "ðŸ“¦ Creating deployment package from branch"
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð² Ñ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ð¼Ð¸ Ñ„Ð°Ð¹Ð»Ð°Ð¼Ð¸ Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ
          tar -czf deployment.tar.gz \
            docker-compose.yml \
            frontend/ \
            backend/ \
            nginx/ \
            --exclude='frontend/node_modules' \
            --exclude='backend/node_modules' \
            --exclude='frontend/.git' \
            --exclude='backend/.git' \
            --exclude='**/dist' \
            --exclude='**/.DS_Store'
          
          echo "âœ… Created deployment package"
          ls -lh deployment.tar.gz

      - name: Copy deployment package to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "deployment.tar.gz"
          target: "/tmp/"

      - name: Deploy with Docker Compose on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e

            # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
            cd ${{ secrets.VPS_DEPLOY_PATH }}

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½ÑƒÑŽ ÐºÐ¾Ð¿Ð¸ÑŽ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð²ÐµÑ€ÑÐ¸Ð¸
            if [ -d "current" ]; then
              echo "Creating backup..."
              BACKUP_DIR="backup_$(date +%Y%m%d_%H%M%S)"
              cp -r current "$BACKUP_DIR"
              
              # ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ðµ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
              echo "Stopping current containers..."
              cd current
              docker-compose down || true
              cd ..
              
              # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð±ÑÐºÐ°Ð¿Ñ‹ (Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 5)
              ls -t | grep "backup_" | tail -n +6 | xargs -r rm -rf
            fi

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ð½Ð¾Ð²Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸
            mkdir -p current

            # Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²Ñ‹Ð²Ð°ÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ
            echo "Extracting new version..."
            tar -xzf /tmp/deployment.tar.gz -C current/

            # ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ñ Ð½Ð¾Ð²Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸ÐµÐ¹
            cd current

            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ .env Ñ„Ð°Ð¹Ð» ÐµÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚
            if [ ! -f .env ]; then
              echo "Creating .env file..."
              cat > .env << EOF
            NODE_ENV=production
            FRONTEND_PORT=80
            BACKEND_PORT=3000
            EOF
            fi

            # Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹
            echo "Building and starting containers..."
            docker-compose build --no-cache
            docker-compose up -d

            # Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
            echo "Waiting for containers to start..."
            sleep 10

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð¾Ð²
            echo "Checking container status..."
            docker-compose ps

            # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°
            rm /tmp/deployment.tar.gz

            # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
            echo "Cleaning up unused images..."
            docker image prune -f

            echo "âœ… Deployment completed successfully!"

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
            echo "Running health checks..."

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° nginx
            if docker ps | grep -q "aregrp-nginx"; then
              echo "âœ… Nginx container is running"
            else
              echo "âŒ Nginx container is not running"
              exit 1
            fi

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° frontend
            if docker ps | grep -q "aregrp-frontend"; then
              echo "âœ… Frontend container is running"
            else
              echo "âŒ Frontend container is not running"
              exit 1
            fi

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° backend
            if docker ps | grep -q "aregrp-backend"; then
              echo "âœ… Backend container is running"
            else
              echo "âŒ Backend container is not running"
              exit 1
            fi

            # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° HTTP Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸
            sleep 5
            if curl -f -s http://localhost > /dev/null; then
              echo "âœ… HTTP endpoint is accessible"
            else
              echo "âŒ HTTP endpoint is not accessible"
              exit 1
            fi

      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          sleep 5

          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ production URL
          if curl -f -s ${{ secrets.PRODUCTION_URL }} > /dev/null; then
            echo "âœ… Production URL is accessible"
          else
            echo "âŒ Production URL is not accessible"
            exit 1
          fi

      - name: Save deployment info
        if: success()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd ${{ secrets.VPS_DEPLOY_PATH }}/current
            
            # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð´ÐµÐ¿Ð»Ð¾Ðµ
            if [ -n "${{ steps.deploy_source.outputs.tag }}" ]; then
              echo "${{ steps.deploy_source.outputs.tag }}" > DEPLOYED_VERSION
              echo "ðŸ“Œ Deployed version: ${{ steps.deploy_source.outputs.tag }}"
            else
              echo "${{ github.sha }}" > DEPLOYED_VERSION
              echo "ðŸ“Œ Deployed commit: ${{ github.sha }}"
            fi

      - name: Create deployment summary
        if: always()
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "### âœ… Deployment Successful!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Application URL:** ${{ secrets.PRODUCTION_URL }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ -n "${{ steps.deploy_source.outputs.tag }}" ]; then
              echo "**Deployed Version:** ${{ steps.deploy_source.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
              echo "**Source:** Release" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Deployed Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
              echo "**Source:** Branch (\`${{ github.ref_name }}\`)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### âŒ Deployment Failed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs for more details." >> $GITHUB_STEP_SUMMARY
          fi
