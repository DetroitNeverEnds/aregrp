name: Deploy to VPS

on:
  push:
    branches: [main]
    paths:
      - "frontend/**"
      - "backend/**"
      - "nginx/**"
      - "docker-compose.yml"
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    environment:
      name: production
      url: ${{ secrets.PRODUCTION_URL }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏ –¥–ª—è –¥–µ–ø–ª–æ—è
          tar -czf deployment.tar.gz \
            docker-compose.yml \
            frontend/ \
            backend/ \
            nginx/ \
            --exclude='frontend/node_modules' \
            --exclude='backend/node_modules' \
            --exclude='frontend/.git' \
            --exclude='backend/.git' \
            --exclude='**/dist' \
            --exclude='**/.DS_Store'

      - name: Copy deployment package to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: "deployment.tar.gz"
          target: "/tmp/"

      - name: Deploy with Docker Compose on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            set -e

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd ${{ secrets.VPS_DEPLOY_PATH }}

            # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏
            if [ -d "current" ]; then
              echo "Creating backup..."
              BACKUP_DIR="backup_$(date +%Y%m%d_%H%M%S)"
              cp -r current "$BACKUP_DIR"
              
              # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
              echo "Stopping current containers..."
              cd current
              docker-compose down || true
              cd ..
              
              # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5)
              ls -t | grep "backup_" | tail -n +6 | xargs -r rm -rf
            fi

            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
            mkdir -p current

            # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
            echo "Extracting new version..."
            tar -xzf /tmp/deployment.tar.gz -C current/

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π
            cd current

            # –°–æ–∑–¥–∞–µ–º .env —Ñ–∞–π–ª –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            if [ ! -f .env ]; then
              echo "Creating .env file..."
              cat > .env << EOF
            NODE_ENV=production
            FRONTEND_PORT=80
            BACKEND_PORT=3000
            EOF
            fi

            # –°–æ–∑–¥–∞–µ–º backend/.env —Ñ–∞–π–ª –∏–∑ GitHub Secrets
            echo "Creating backend/.env file..."
            mkdir -p backend
            cat > backend/.env << EOF
COMPOSE_BAKE=${{ secrets.COMPOSE_BAKE || 'true' }}
DEBUG=${{ secrets.DEBUG || 'False' }}
ALLOWED_HOSTS=${{ secrets.ALLOWED_HOSTS }}
CORS_ALLOWED_ORIGINS=${{ secrets.CORS_ALLOWED_ORIGINS }}
CORS_ALLOW_ALL_ORIGINS=${{ secrets.CORS_ALLOW_ALL_ORIGINS || 'False' }}
CSRF_TRUSTED_ORIGINS=${{ secrets.CSRF_TRUSTED_ORIGINS }}
DATABASE_URL=${{ secrets.DATABASE_URL }}
DJANGO_SUPERUSER_USERNAME=${{ secrets.DJANGO_SUPERUSER_USERNAME }}
DJANGO_SUPERUSER_PASSWORD=${{ secrets.DJANGO_SUPERUSER_PASSWORD }}
DJANGO_SUPERUSER_EMAIL=${{ secrets.DJANGO_SUPERUSER_EMAIL }}
DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
ACCESS_TOKEN_LIFETIME_MINUTES=${{ secrets.ACCESS_TOKEN_LIFETIME_MINUTES || '15' }}
REFRESH_TOKEN_LIFETIME_DAYS=${{ secrets.REFRESH_TOKEN_LIFETIME_DAYS || '7' }}
PASSWORD_RESET_TOKEN_LIFETIME_HOURS=${{ secrets.PASSWORD_RESET_TOKEN_LIFETIME_HOURS || '24' }}
EMAIL_BACKEND=${{ secrets.EMAIL_BACKEND || 'django.core.mail.backends.smtp.EmailBackend' }}
EMAIL_HOST=${{ secrets.EMAIL_HOST }}
EMAIL_PORT=${{ secrets.EMAIL_PORT || '587' }}
EMAIL_USE_TLS=${{ secrets.EMAIL_USE_TLS || 'True' }}
EMAIL_HOST_USER=${{ secrets.EMAIL_HOST_USER }}
EMAIL_HOST_PASSWORD=${{ secrets.EMAIL_HOST_PASSWORD }}
DEFAULT_FROM_EMAIL=${{ secrets.DEFAULT_FROM_EMAIL }}
FRONTEND_URL=${{ secrets.FRONTEND_URL }}
EOF

            # –°–æ–∑–¥–∞–µ–º backend/.env.postgres —Ñ–∞–π–ª –∏–∑ GitHub Secrets
            echo "Creating backend/.env.postgres file..."
            cat > backend/.env.postgres << EOF
TZ=${{ secrets.TZ || 'UTC' }}
PGTZ=${{ secrets.PGTZ || 'UTC' }}
POSTGRES_DB=${{ secrets.POSTGRES_DB }}
POSTGRES_USER=${{ secrets.POSTGRES_USER }}
POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}
EOF

            # –°–æ–±–∏—Ä–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
            echo "Building and starting containers..."
            docker-compose build --no-cache
            docker-compose up -d

            # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "Waiting for containers to start..."
            sleep 10

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "Checking container status..."
            docker-compose ps

            # –û—á–∏—Å—Ç–∫–∞
            rm /tmp/deployment.tar.gz

            # –£–¥–∞–ª—è–µ–º –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –æ–±—Ä–∞–∑—ã
            echo "Cleaning up unused images..."
            docker image prune -f

            echo "‚úÖ Deployment completed successfully!"

      - name: Health check
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤
            echo "Running health checks..."

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ nginx
            if docker ps | grep -q "aregrp-nginx"; then
              echo "‚úÖ Nginx container is running"
            else
              echo "‚ùå Nginx container is not running"
              exit 1
            fi

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ frontend
            if docker ps | grep -q "aregrp-frontend"; then
              echo "‚úÖ Frontend container is running"
            else
              echo "‚ùå Frontend container is not running"
              exit 1
            fi

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ backend
            if docker ps | grep -q "aregrp-backend"; then
              echo "‚úÖ Backend container is running"
            else
              echo "‚ùå Backend container is not running"
              exit 1
            fi

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ HTTP –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
            sleep 5
            if curl -f -s http://localhost > /dev/null; then
              echo "‚úÖ HTTP endpoint is accessible"
            else
              echo "‚ùå HTTP endpoint is not accessible"
              exit 1
            fi

      - name: Verify deployment
        run: |
          echo "Verifying deployment..."
          sleep 5

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å production URL
          if curl -f -s ${{ secrets.PRODUCTION_URL }} > /dev/null; then
            echo "‚úÖ Production URL is accessible"
          else
            echo "‚ùå Production URL is not accessible"
            exit 1
          fi

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Deployment successful!"
            echo "üöÄ Application is now running at ${{ secrets.PRODUCTION_URL }}"
          else
            echo "‚ùå Deployment failed!"
            echo "Please check the logs for more details."
          fi
