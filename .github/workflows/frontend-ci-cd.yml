name: Frontend CI/CD Pipeline

on:
    pull_request:
        branches: [main, develop]
        paths:
            - "frontend/**"
    workflow_dispatch:

jobs:
    code-quality:
        name: Code Quality
        uses: ./.github/workflows/frontend-code-quality.yml

    test:
        name: Tests
        uses: ./.github/workflows/frontend-test.yml
        needs: code-quality

    build:
        name: Build
        uses: ./.github/workflows/frontend-build.yml
        needs: test

    storybook-testing:
        name: Storybook Publish (Testing)
        uses: ./.github/workflows/frontend-storybook-publish.yml
        with:
            environment: testing
            retention-days: 7
        needs: code-quality
        permissions:
            contents: read
            pages: write
            id-token: write

    summary:
        name: Pipeline Summary
        runs-on: ubuntu-latest
        needs: [code-quality, test, build, storybook-testing]
        if: always()

        steps:
            - name: Check pipeline status
              run: |
                  echo "## Pipeline Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Storybook (Testing) | ${{ needs.storybook-testing.result }} |" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ needs.code-quality.result }}" == "success" ] && \
                     [ "${{ needs.test.result }}" == "success" ] && \
                     [ "${{ needs.build.result }}" == "success" ] && \
                     [ "${{ needs.storybook-testing.result }}" == "success" ]; then
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "✅ All checks passed successfully!" >> $GITHUB_STEP_SUMMARY
                    exit 0
                  else
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "❌ Some checks failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
                    exit 1
                  fi
