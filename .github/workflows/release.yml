name: Create Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag version (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÑŽ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ changelog
          
      - name: Get version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT
          
      - name: Verify version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! [[ $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: v1.0.0"
            exit 1
          fi
          echo "âœ… Version format is valid: $VERSION"
          
      - name: Check if tag exists
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "âœ… Tag $VERSION exists"
          else
            echo "âŒ Tag $VERSION does not exist"
            exit 1
          fi
          
      - name: Get previous tag
        id: previous_tag
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 ${{ steps.version.outputs.version }}^ 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "No previous tag found, this is the first release"
            echo "previous_tag=" >> $GITHUB_OUTPUT
          else
            echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
            echo "Previous tag: $PREVIOUS_TAG"
          fi
          
      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PREVIOUS_TAG="${{ steps.previous_tag.outputs.previous_tag }}"
          
          echo "# ðŸ“‹ Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "## ðŸŽ‰ Initial Release" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "This is the first release of the project." >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "### All Changes" >> CHANGELOG.md
            git log --pretty=format:"- %s (%h)" >> CHANGELOG.md
          else
            echo "## Changes from $PREVIOUS_TAG to $VERSION" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            # Ð“Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹ Ð¿Ð¾ Ñ‚Ð¸Ð¿Ð°Ð¼
            echo "### âœ¨ Features" >> CHANGELOG.md
            git log $PREVIOUS_TAG..$VERSION --pretty=format:"%s (%h)" --grep="^feat" >> CHANGELOG.md || echo "No new features" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            echo "### ðŸ› Bug Fixes" >> CHANGELOG.md
            git log $PREVIOUS_TAG..$VERSION --pretty=format:"- %s (%h)" --grep="^fix" >> CHANGELOG.md || echo "No bug fixes" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            echo "### ðŸ“š Documentation" >> CHANGELOG.md
            git log $PREVIOUS_TAG..$VERSION --pretty=format:"- %s (%h)" --grep="^docs" >> CHANGELOG.md || echo "No documentation changes" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            echo "### ðŸ”§ Other Changes" >> CHANGELOG.md
            git log $PREVIOUS_TAG..$VERSION --pretty=format:"- %s (%h)" --invert-grep --grep="^feat" --grep="^fix" --grep="^docs" >> CHANGELOG.md || echo "No other changes" >> CHANGELOG.md
          fi
          
          echo "" >> CHANGELOG.md
          echo "---" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...$VERSION" >> CHANGELOG.md
          
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ changelog Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² Ñ€ÐµÐ»Ð¸Ð·Ðµ
          cat CHANGELOG.md
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
          
      - name: Create deployment package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð² Ñ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¼ ÐºÐ¾Ð´Ð¾Ð¼
          tar -czf aregrp-source-$VERSION.tar.gz \
            --exclude='frontend/node_modules' \
            --exclude='backend/__pycache__' \
            --exclude='frontend/dist' \
            --exclude='**/.*' \
            --exclude='**/.git' \
            frontend/ backend/ nginx/ docker-compose.yml
            
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð² Ñ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¼ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð¾Ð¼
          cd frontend/dist
          tar -czf ../../aregrp-frontend-build-$VERSION.tar.gz .
          cd ../..
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð² Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ (Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ Ðº Ð·Ð°Ð¿ÑƒÑÐºÑƒ)
          tar -czf aregrp-deploy-$VERSION.tar.gz \
            docker-compose.yml \
            nginx/ \
            frontend/dist/ \
            backend/ \
            --exclude='backend/__pycache__' \
            --exclude='backend/.git'
            
          echo "âœ… Created deployment packages:"
          ls -lh aregrp-*.tar.gz
          
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            aregrp-source-${{ steps.version.outputs.version }}.tar.gz
            aregrp-frontend-build-${{ steps.version.outputs.version }}.tar.gz
            aregrp-deploy-${{ steps.version.outputs.version }}.tar.gz
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Update version in package.json
        run: |
          VERSION="${{ steps.version.outputs.version_number }}"
          cd frontend
          npm version $VERSION --no-git-tag-version
          
      - name: Update version in pyproject.toml
        run: |
          VERSION="${{ steps.version.outputs.version_number }}"
          cd backend
          sed -i "s/^version = .*/version = \"$VERSION\"/" pyproject.toml
          
      - name: Commit version updates
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add frontend/package.json backend/pyproject.toml
          git commit -m "chore: bump version to $VERSION" || echo "No changes to commit"
          git push origin HEAD:main || echo "Nothing to push"
          
      - name: Create release summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "## ðŸš€ Release $VERSION Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- \`aregrp-source-$VERSION.tar.gz\` - Ð˜ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ ÐºÐ¾Ð´" >> $GITHUB_STEP_SUMMARY
          echo "- \`aregrp-frontend-build-$VERSION.tar.gz\` - Ð¡Ð¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´" >> $GITHUB_STEP_SUMMARY
          echo "- \`aregrp-deploy-$VERSION.tar.gz\` - Ð“Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ Ðº Ð´ÐµÐ¿Ð»Ð¾ÑŽ Ð¿Ð°ÐºÐµÑ‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [View Release](https://github.com/${{ github.repository }}/releases/tag/$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Assets](https://github.com/${{ github.repository }}/releases/download/$VERSION/)" >> $GITHUB_STEP_SUMMARY
          
  notify:
    name: Notify Release
    needs: create-release
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: Send notification
        run: |
          echo "âœ… Release created successfully!"
          echo "ðŸŽ‰ Version: ${{ needs.create-release.outputs.version }}"