name: Storybook Publish

on:
    workflow_call:
        inputs:
            environment:
                description: "Deployment environment (testing or production)"
                required: true
                type: string
            retention-days:
                description: "Artifact retention days"
                required: false
                type: number
                default: 7
    workflow_dispatch:
        inputs:
            environment:
                description: "Deployment environment"
                required: true
                type: choice
                options:
                    - testing
                    - production
                default: testing
            retention-days:
                description: "Artifact retention days"
                required: false
                type: number
                default: 7

defaults:
    run:
        working-directory: frontend

jobs:
    build-storybook:
        name: Build Storybook
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"
                  cache-dependency-path: frontend/package-lock.json

            - name: Install dependencies
              run: npm ci

            - name: Build Storybook
              run: |
                  if [ "${{ inputs.environment }}" == "production" ]; then
                    npm run build-storybook -- -o storybook-static
                  else
                    npm run build-storybook -- -o storybook-static/testing
                  fi

            - name: Upload Storybook artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: storybook-static-${{ inputs.environment }}
                  path: frontend/storybook-static
                  retention-days: ${{ inputs.retention-days }}

    publish-storybook:
        name: Publish to GitHub Pages
        runs-on: ubuntu-latest
        needs: build-storybook

        permissions:
            contents: read
            pages: write
            id-token: write

        environment:
            name: github-pages
            url: ${{ inputs.environment == 'production' && steps.deployment.outputs.page_url || format('{0}testing/', steps.deployment.outputs.page_url) }}

        steps:
            - name: Download Storybook artifacts
              uses: actions/download-artifact@v4
              with:
                  name: storybook-static-${{ inputs.environment }}
                  path: storybook-static

            - name: Setup Pages
              uses: actions/configure-pages@v4

            - name: Upload to GitHub Pages
              uses: actions/upload-pages-artifact@v3
              with:
                  path: storybook-static

            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4

            - name: Add deployment summary
              working-directory: .
              run: |
                  ENV_TYPE="${{ inputs.environment }}"

                  if [ "$ENV_TYPE" == "production" ]; then
                    echo "## ðŸš€ Storybook Production Deployment" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "âœ… Storybook successfully deployed to GitHub Pages (Production)" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "## ðŸ§ª Storybook Testing Deployment" >> $GITHUB_STEP_SUMMARY
                    echo "" >> $GITHUB_STEP_SUMMARY
                    echo "âœ… Storybook successfully deployed to GitHub Pages (Testing)" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ”— **URL:** ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "ðŸ“¦ **Environment:** $ENV_TYPE" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ github.event_name }}" == "pull_request" ]; then
                    echo "ðŸ”€ **PR:** #${{ github.event.pull_request.number }}" >> $GITHUB_STEP_SUMMARY
                    echo "ðŸ“ **Title:** ${{ github.event.pull_request.title }}" >> $GITHUB_STEP_SUMMARY
                  elif [ "${{ github.event_name }}" == "push" ]; then
                    echo "ðŸŒ¿ **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                    echo "ðŸ“ **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "$ENV_TYPE" == "production" ]; then
                    echo "> âœ¨ This is the production deployment. All components are stable and ready for use." >> $GITHUB_STEP_SUMMARY
                  else
                    echo "> âš ï¸ This is a testing deployment. Changes may be overwritten by subsequent deployments." >> $GITHUB_STEP_SUMMARY
                  fi
